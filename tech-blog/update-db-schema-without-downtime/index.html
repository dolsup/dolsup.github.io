<!doctype html><html lang=ko-kr><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>다운타임 없이 MySQL DB 스키마 업데이트하는 여러가지 방법 - 돌과 숲</title><meta name=description content="서비스를 개발하고 운영하다 보면 데이터베이스 스키마를 변경해야 할 때가 생깁니다. 특히 애자일하게 개발하는 경우 DB 스키마를 변경할 일이 많습니다. 점검 공지를 한"><meta name=author content="dolsup"><meta name=date content="2020-12-30 08:09:40 +0000 UTC"><meta http-equiv=last-modified content="2021-06-15 17:18:26 +0900 +0900"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-49954888-5"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-49954888-5');gtag('set',{'user_id':'USER_ID'});</script><script async src=https://dolsup.work/scripts/prism.js></script><link rel=stylesheet href=https://dolsup.work//styles/applause-button.css><script src=https://dolsup.work//scripts/applause-button.js></script><link href=https://dolsup.work/css/font.css rel=stylesheet><link href=https://dolsup.work/css/atom-one-dark.min.css rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,700,700i" rel=stylesheet><link href=https://dolsup.work/css/style.css rel=stylesheet><link href=https://dolsup.work/styles/post.css rel=stylesheet><link href=https://dolsup.work/styles/prism.css rel=stylesheet><link rel=apple-touch-icon href=https://dolsup.work/img/apple-touch-icon.png><link rel=icon href=https://dolsup.work/img/favicon.ico><meta name=generator content="Hugo 0.75.1"><link rel=alternate type=application/atom+xml href=https://dolsup.work/index.xml title="돌과 숲"></head><body class=single><header class=header><p class=title><a href=https://dolsup.work/>돌과 숲</a></p><input class=menu-toggle type=checkbox><nav class=menu><ul><a href=/about><li>About</li></a><a href=/tech-blog><li>개발 블로그</li></a><hr></ul></nav></header><main class=main><article class="post post-view"><header class=post-header><h1 class=post-title>다운타임 없이 MySQL DB 스키마 업데이트하는 여러가지 방법</h1><p class=post-meta><span>2020.12.30</span>
<span>발행</span>
<span>·</span>
<span>2021.6.15</span>
<span>편집</span></p><ul class=post-tags><li><a href=https://dolsup.work/tags/database/>Database</a></li><li><a href=https://dolsup.work/tags/mysql/>MySQL</a></li><li><a href=https://dolsup.work/tags/percona-toolkit/>percona-toolkit</a></li><li><a href=https://dolsup.work/tags/pt-online-schema-change/>pt-online-schema-change</a></li><li><a href=https://dolsup.work/tags/gh-ost/>gh-ost</a></li></ul></header><div class=post-content><p>서비스를 개발하고 운영하다 보면 데이터베이스 스키마를 변경해야 할 때가 생깁니다. 특히 애자일하게 개발하는 경우 DB 스키마를 변경할 일이 많습니다.</p><p>점검 공지를 한 뒤 서비스를 잠시 중단하고 할 수 있다면 별 문제가 없지만 그렇게 하기 어려운 경우도 있습니다. 제가 겪은 사례에서는 높은 <a href=https://ko.wikipedia.org/wiki/%EA%B0%80%EC%9A%A9%EC%84%B1>가용성</a>이 보장되어야 하는 IoT 서버가 DB에 의존하고 있었고 &lsquo;서버 점검&rsquo;을 통지하는 절차가 딱히 없었습니다. 행 개수가 수천만개에 달하는 거대한 테이블의 컬럼 데이터 타입을 바꿔야 했는데, 그냥 바꿔버리면 스키마가 변경되는 동안 다른 DML 쿼리들이 block되고 DB 서버의 부하가 폭증해서 서비스가 먹통이 될 우려가 있습니다.</p><p>그러면 다운타임 없이 DB 스키마를 운영 환경에서 변경하고자 하려면 어떻게 해야 할까요? MySQL 기준으로 알아보겠습니다.</p><h2 id=내가-실행하고자-하는-ddl이-online-ddl인지-먼저-확인>내가 실행하고자 하는 DDL이 online DDL인지 먼저 확인</h2><p>👉참고: InnoDB Online DDL Operations: <a href=https://dev.mysql.com/doc/refman/5.6/en/innodb-online-ddl-operations.html>MySQL 5.6</a>, <a href=https://dev.mysql.com/doc/refman/5.7/en/innodb-online-ddl-operations.html>MySQL 5.7</a></p><p>MySQL이 내부적으로 테이블 스키마를 변경하는 전통적인 방법은 새 스키마가 반영된 테이블로 전체 데이터를 카피하고 인덱스를 리빌드하는 것입니다. 오래 걸리고 DML을 block하는 작업입니다.</p><p>하지만 MySQL 5.6, MariaDB 10.0부터는 online DDL을 지원합니다. 테이블 스키마를 수정하는 동안 DML(insert, update, delete)가 가능한 것입니다. 하지만 모든 DDL이 지원되는 것은 아닙니다. operation 마다 조금씩 다릅니다.</p><p>저는 컬럼 데이터 타입을 변경하려 했는데 이 작업은 online DDL이 지원되지 않습니다. <code>In Place</code>가 <code>No</code>이고, 테이블을 리빌드하며, 동시 DML을 허용하지 않는 동작입니다. 그냥 <code>ALTER TABLE ...</code> 쿼리를 실행해버리면 테이블 수정이 완료되기까지 억겁의 시간동안 기다려야 하고 그동안 그 테이블은 <code>INSERT</code>, <code>UPDATE</code>, <code>DELETE</code>가 안 됩니다. 미친듯이 쏟아지는 에러 메시지를 받게 될 것입니다&mldr;</p><h3 id=유의할-점들>유의할 점들</h3><ul><li>online DDL이 지원되는 DDL이라고 해서 운영에 전혀 영향을 안 미치지는 않습니다. alter 중에 높은 부하와 그에 따른 장애로 쿼리 타임아웃이 증가하거나 복제 지연(replication lag)이 커질 수 있습니다. 운영 환경에서 저지르기 전에 stage나 테스트 환경에서 먼저 해보는 것이 좋습니다.</li><li>MySQL 5.7.23 버전 이전에서는 인덱스 걸린 VARCHAR 칼럼의 사이즈를 확장할 때 인덱스 리빌딩이 이루어집니다.<br>👉<a href=https://gywn.net/2018/10/online-alter-for-varchar/>참고: Online Alter에도 헛점은 있더구나</a></li><li>online DDL 중 사용하는 임시 로그파일이 지정된 <a href=https://dev.mysql.com/doc/refman/5.6/en/innodb-parameters.html#sysvar_innodb_online_alter_log_max_size>innodb_online_alter_log_max_size</a> 값을 초과한 경우 alter가 중단됩니다.<br>👉<a href=https://m.blog.naver.com/parkjy76/221790031480>참고: mysql online ddl 시 유의할 점</a></li></ul><h2 id=고전적인-방법>고전적인 방법</h2><p>다운타임이 예상된다면 고전적인 방법을 사용하는 수밖에 없습니다.</p><ol><li>dump & modify schema: 새 스키마로 빈 테이블을 생성하고 데이터를 새 테이블에 옮긴다. 또는 테이블을 복제한 후 스키마를 바꾼다.</li><li>sync: 구 테이블의 데이터의 변경사항을 실시간으로 새 테이블에도 반영한다.</li><li>replace: 두 테이블의 데이터가 완전히 동기화되면 새 테이블로 기존 테이블을 교체한다.</li></ol><p>하지만 이걸 직접 하거나 이걸 수행하는 스크립팅하는 것은 매우 번거롭고 예상하기 어려운 문제도 많습니다. 다행히도 이런 절차를 자동화해주는 소프트웨어들이 있습니다.</p><h3 id=pt-online-schema-change>pt-online-schema-change</h3><p>percona의 percona-toolkit에 포함된 <a href=https://www.percona.com/doc/percona-toolkit/3.0/pt-online-schema-change.html>pt-online-schema-change</a>입니다.</p><h3 id=gh-ost>gh-ost</h3><p><a href=https://github.com/github/gh-ost>github/gh-ost (GitHub)</a><br>GitHub가 만들었으며 pt-online-schema-change 이후에 등장했으며 설계상 이점이 있습니다. AWS RDS에서 사용하는 경우 제한이 있기 때문에 관련 <a href=https://github.com/github/gh-ost/blob/master/doc/rds.md>문서</a>를 참고해야 합니다.</p><ul><li>👉<a href=https://m.blog.naver.com/sory1008/221131621433>참고: gh-ost research</a></li><li>👉<a href=https://github.blog/2016-08-01-gh-ost-github-s-online-migration-tool-for-mysql/>참고: gh-ost: GitHub’s online schema migration tool for MySQL</a></li></ul><h2 id=결론>결론</h2><ul><li>스키마 변경은 비용이 많이 드는 작업이다.</li><li>그러나 online DDL 조건에 맞으면 그냥 alter 할 수 있다.</li><li>그렇지 않으면 pt-online-schema-change나 gh-ost를 사용한다.</li></ul></div><footer class=post-footer><div class=applause-button-container><applause-button url=https://dolsup.work/tech-blog/update-db-schema-without-downtime/ style="width: 3em; height: 3em; margin: 0 auto"></div><div id=comments-container><script src=https://utteranc.es/client.js data-repo=dolsup/dolsup.github.io data-issue-term=title label=utterance data-theme=github-light crossorigin=anonymous async></script></div></footer></article></main><footer class=footer><span>&copy; 2021 돌과 숲</span>
<span>&#183;</span>
<a href=https://github.com/dolsup class=link>GitHub</a></footer></body></html>